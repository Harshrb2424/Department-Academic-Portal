<!DOCTYPE html>
<html lang="en" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Resource Portal - MRCE</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        },
                        brand: {
                            500: '#06b6d4',
                            600: '#0891b2',
                        }
                    }
                }
            }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Smooth details animation */
        details>summary {
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body
    class="bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-200 font-sans antialiased min-h-screen flex flex-col transition-colors duration-300">

    <nav
        class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 sticky top-0 z-50 transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">

                <div class="flex items-center gap-3">
                    <div class="relative group">
                        <div class="absolute -inset-0.5 group-hover:opacity-100 blur transition duration-200"></div>
                        <img src="./images/AIML LOGO.png" alt="MRCE AIML Logo"
                            class="relative h-12 w-12 md:h-16 md:w-16">
                    </div>

                    <div class="flex flex-col justify-center">
                        <span
                            class="font-bold text-base md:text-lg tracking-tight leading-tight text-slate-800 dark:text-white line-clamp-1">
                            Academic Resource Portal - <span class="text-brand-500">MRCE</span>
                        </span>
                        <span
                            class="text-[9px] md:text-[10px] font-semibold tracking-wider uppercase text-slate-500 dark:text-slate-400">
                            By Plexus Club - Dept of CSE (AIML)
                        </span>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="app.toggleMobileFilters()"
                        class="md:hidden p-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:text-brand-600 transition-colors relative">
                        <i class="ph ph-funnel text-xl"></i>
                        <span id="mobileFilterDot"
                            class="hidden absolute top-2 right-2 h-2 w-2 rounded-full bg-brand-500 border border-white dark:border-slate-800"></span>
                    </button>

                    <div id="statusIndicator"
                        class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full border text-xs font-semibold transition-all duration-300 bg-slate-50/50 border-slate-200 text-slate-600 dark:bg-slate-800/50 dark:border-slate-700 dark:text-slate-400">
                        <span class="relative flex h-2 w-2">
                            <span id="statusDotPulse"
                                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                            <span id="statusDot"
                                class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                        </span>
                        <span id="statusText">System Ready</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <header id="filterTray"
        class="hidden md:block bg-white/95 dark:bg-slate-900/95 backdrop-blur-sm border-b border-slate-200 dark:border-slate-800 shadow-sm z-40 sticky top-16 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label
                        class="block text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1">Regulation</label>
                    <div class="relative">
                        <select id="regSelect"
                            class="w-full appearance-none bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 text-slate-900 dark:text-slate-200 rounded-lg text-sm p-2.5 pr-8 focus:ring-brand-500 focus:border-brand-500 transition-colors">
                            <option value="">Select Regulation...</option>
                        </select>
                        <i class="ph ph-caret-down absolute right-3 top-3 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                <div>
                    <label
                        class="block text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1">Department</label>
                    <div class="relative">
                        <select id="deptSelect"
                            class="w-full appearance-none bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 text-slate-900 dark:text-slate-200 rounded-lg text-sm p-2.5 pr-8 focus:ring-brand-500 focus:border-brand-500 transition-colors disabled:opacity-50"
                            disabled>
                            <option value="">Select Dept...</option>
                        </select>
                        <i class="ph ph-caret-down absolute right-3 top-3 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                <div>
                    <label
                        class="block text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1">Batch</label>
                    <div class="relative">
                        <select id="batchSelect"
                            class="w-full appearance-none bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 text-slate-900 dark:text-slate-200 rounded-lg text-sm p-2.5 pr-8 focus:ring-brand-500 focus:border-brand-500 transition-colors disabled:opacity-50"
                            disabled>
                            <option value="">Select Batch...</option>
                        </select>
                        <i class="ph ph-caret-down absolute right-3 top-3 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                <div>
                    <label
                        class="block text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1">Year
                        & Sem</label>
                    <div class="relative">
                        <select id="yearSemSelect"
                            class="w-full appearance-none bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 text-slate-900 dark:text-slate-200 rounded-lg text-sm p-2.5 pr-8 focus:ring-brand-500 focus:border-brand-500 transition-colors disabled:opacity-50"
                            disabled>
                            <option value="">Select Y/S...</option>
                        </select>
                        <i class="ph ph-caret-down absolute right-3 top-3 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                <div class="md:hidden pt-2">
                    <button onclick="app.toggleMobileFilters()"
                        class="w-full py-2 bg-brand-500 text-white rounded-lg text-sm font-semibold">Apply &
                        Close</button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 w-full">

        <div id="welcomeState" class="text-center py-20 fade-in">
            <div class="relative inline-flex items-center justify-center w-16 h-16 md:w-20 md:h-20 mb-6">
                <div class="absolute inset-0 bg-brand-500/20 blur-xl rounded-full"></div>
                <div
                    class="relative inline-flex items-center justify-center w-16 h-16 md:w-20 md:h-20 rounded-2xl bg-white dark:bg-slate-800 shadow-xl border border-slate-100 dark:border-slate-700 text-brand-600 dark:text-brand-400">
                    <i class="ph ph-graduation-cap text-3xl md:text-4xl"></i>
                </div>
            </div>
            <h2 class="text-xl md:text-2xl font-bold text-slate-900 dark:text-white transition-colors">Select Filters to
                Begin</h2>
            <p class="text-sm md:text-base text-slate-500 dark:text-slate-400 mt-2 max-w-md mx-auto">Access lecture
                notes, project archives, and syllabus details.</p>
            <button onclick="app.toggleMobileFilters()"
                class="md:hidden mt-6 px-6 py-2 bg-brand-50 text-brand-700 border border-brand-200 rounded-full text-sm font-medium">Open
                Filters</button>
        </div>

        <div id="mainContent" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">

            <div class="lg:col-span-8 space-y-6">
                <div class="flex items-center justify-between border-b border-slate-200 dark:border-slate-800 pb-4">
                    <h2 class="text-lg md:text-xl font-bold text-slate-800 dark:text-slate-200 flex items-center gap-2">
                        <span class="p-1.5 rounded bg-brand-50 dark:bg-slate-800 text-brand-600"><i
                                class="ph ph-books"></i></span>
                        Subjects & Syllabus
                        <span id="currentSemText"
                            class="ml-2 text-sm font-normal text-slate-500 dark:text-slate-400"></span>
                    </h2>
                </div>
                <div id="subjectsContainer" class="space-y-4">
                </div>
            </div>

            <div class="lg:col-span-4 space-y-4 lg:sticky lg:top-44">
                <div
                    class="flex items-center justify-between border-b border-slate-200 dark:border-slate-800 pb-4 mt-8 lg:mt-0">
                    <h2 class="text-lg md:text-xl font-bold text-slate-800 dark:text-slate-200 flex items-center gap-2">
                        <span class="p-1.5 rounded bg-emerald-50 dark:bg-slate-800 text-emerald-600"><i
                                class="ph ph-projector-screen-chart"></i></span>
                        Projects
                    </h2>
                </div>

                <div class="relative">
                    <select id="classSelect"
                        class="hidden w-full appearance-none text-sm border-slate-300 dark:border-slate-700 rounded-md shadow-sm p-2.5 border bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 focus:ring-emerald-500 focus:border-emerald-500">
                    </select>
                </div>

                <div id="projectsContainer"
                    class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors">
                    <div class="p-8 text-center text-slate-400 dark:text-slate-500 flex flex-col items-center">
                        <i class="ph ph-chalkboard-teacher text-3xl mb-2"></i>
                        <p class="text-sm">Select filters to load class projects</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer
        class="bg-white dark:bg-slate-950 border-t border-slate-200 dark:border-slate-800 mt-auto transition-colors relative z-10">
        <div class="max-w-7xl mx-auto py-8 px-4">
            <div class="flex flex-col md:flex-row items-center justify-between gap-6">

                <div class="text-sm text-slate-500 dark:text-slate-400 text-center md:text-left">
                    <p>Academic Portal - MRCE</p>
                    <p class="text-xs opacity-75 mt-1">Built for Students.</p>
                </div>

                <div class="flex items-center gap-4 md:gap-6">
                    <a href="https://mrce.in" target="_blank"
                        class="group flex flex-col items-center gap-2 opacity-80 hover:opacity-100 transition-opacity">
                        <div
                            class="h-10 w-10 md:h-12 md:w-12 rounded-md bg-white flex items-center justify-center shadow-sm overflow-hidden border border-slate-200">
                            <img src="https://mrce.in/static%20page/nobg.png" alt="MRCE Logo"
                                class="h-full w-full object-contain">
                        </div>
                        <span
                            class="text-[9px] font-bold tracking-widest uppercase text-slate-600 dark:text-slate-400 group-hover:text-brand-600 transition-colors">MRCE</span>
                    </a>

                    <div class="h-8 w-px bg-slate-300 dark:bg-slate-700"></div>

                    <a href="https://www.instagram.com/plexus_club_mrce" target="_blank"
                        class="group flex flex-col items-center gap-2 opacity-80 hover:opacity-100 transition-opacity">
                        <div
                            class="h-10 w-10 md:h-12 md:w-12 rounded-md bg-slate-900 flex items-center justify-center shadow-sm overflow-hidden">
                            <img src="./images/plexus.png" alt="Plexus Club" class="h-full w-full object-cover">
                        </div>
                        <span
                            class="text-[9px] font-bold tracking-widest uppercase text-slate-600 dark:text-slate-400 group-hover:text-purple-500 transition-colors">Plexus</span>
                    </a>
                </div>

                <button onclick="app.toggleTheme()"
                    class="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-100 dark:bg-slate-900 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-800 transition-all text-xs font-bold uppercase tracking-wide border border-transparent dark:border-slate-800">
                    <i class="ph ph-sun dark:hidden text-lg text-amber-500"></i>
                    <i class="ph ph-moon hidden dark:block text-lg text-indigo-400"></i>
                    <span class="dark:hidden">Light</span>
                    <span class="hidden dark:block">Dark</span>
                </button>
            </div>
        </div>
    </footer>

    <script>
        const app = {
            state: {
                reg: '',
                batch: '',
                dept: '',
                yearSem: '',
                currentClassId: '',
                mobileFiltersOpen: false
            },
            data: {
                metadata: {},
                curriculum: [],
                subjects: [],
                notes: [],
                classes: [],
                projects: []
            },

            init: async function () {
                // Theme
                if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }

                // URL Params
                const params = new URLSearchParams(window.location.search);
                this.state.reg = params.get('reg') || localStorage.getItem('reg') || '';
                this.state.batch = params.get('batch') || localStorage.getItem('batch') || '';
                this.state.dept = params.get('dept') || localStorage.getItem('dept') || '';
                this.state.yearSem = params.get('yearSem') || localStorage.getItem('yearSem') || '';

                await this.loadMetadata();
                this.setupListeners();

                if (this.state.reg && this.state.batch && this.state.dept) {
                    this.updateUIValues();
                    document.getElementById('mobileFilterDot').classList.remove('hidden');
                    this.fetchCoreData();
                } else {
                    this.updateUIValues();

                    if (window.innerWidth < 640 && !this.state.mobileFiltersOpen) {
                        this.toggleMobileFilters();
                    }
                }
            },

            toggleTheme: function () {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.theme = 'light';
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.theme = 'dark';
                }
            },

            toggleMobileFilters: function () {
                const tray = document.getElementById('filterTray');
                this.state.mobileFiltersOpen = !this.state.mobileFiltersOpen;

                if (this.state.mobileFiltersOpen) {
                    tray.classList.remove('hidden');
                    tray.classList.add('block');
                } else {
                    tray.classList.add('hidden');
                    tray.classList.remove('block');
                }
            },

            loadMetadata: async function () {
                try {
                    // Only fetch metadata here. Curriculum is now Regulation-specific.
                    const res = await fetch('./resources/metadata.json');
                    this.data.metadata = await res.json();

                    this.populateSelect('regSelect', this.data.metadata.regulations);
                    this.populateSelect('batchSelect', this.data.metadata.batches);
                    this.populateSelect('deptSelect', this.data.metadata.departments);
                } catch (e) {
                    console.error("Metadata load failed", e);
                    this.setStatus("Error Loading Metadata", "error");
                }
            },

            setupListeners: function () {
                ['regSelect', 'batchSelect', 'deptSelect'].forEach(id => {
                    document.getElementById(id).addEventListener('change', (e) => {
                        const key = id.replace('Select', '');
                        this.state[key] = e.target.value;

                        // Reset sub-filter
                        if (key !== 'yearSem') {
                            this.state.yearSem = '';
                            document.getElementById('yearSemSelect').value = '';
                        }
                        this.handleStateChange();
                    });
                });

                document.getElementById('yearSemSelect').addEventListener('change', (e) => {
                    this.state.yearSem = e.target.value;
                    this.handleStateChange();
                });

                document.getElementById('classSelect').addEventListener('change', (e) => {
                    this.state.currentClassId = e.target.value;
                    this.fetchProjects(this.state.currentClassId);
                });
            },

            handleStateChange: function () {
                const { reg, batch, dept, yearSem } = this.state;

                localStorage.setItem('reg', reg);
                localStorage.setItem('batch', batch);
                localStorage.setItem('dept', dept);
                localStorage.setItem('yearSem', yearSem);

                const url = new URL(window.location);
                if (reg) url.searchParams.set('reg', reg);
                if (batch) url.searchParams.set('batch', batch);
                if (dept) url.searchParams.set('dept', dept);
                if (yearSem) url.searchParams.set('yearSem', yearSem);
                window.history.pushState({}, '', url);

                document.getElementById('batchSelect').disabled = !reg;
                document.getElementById('deptSelect').disabled = !reg;

                if (reg && batch && dept) {
                    document.getElementById('mobileFilterDot').classList.remove('hidden');
                    this.fetchCoreData();

                    if (yearSem !== '' && this.state.mobileFiltersOpen) {
                        this.toggleMobileFilters();
                    }
                } else {
                    document.getElementById('yearSemSelect').disabled = true;
                    document.getElementById('welcomeState').classList.remove('hidden');
                    document.getElementById('mainContent').classList.add('hidden');
                    document.getElementById('mobileFilterDot').classList.add('hidden');
                }
            },

            fetchCoreData: async function () {
                this.setStatus("Loading...", "loading");
                const { reg, batch, dept } = this.state;

                try {
                    const [subRes, noteRes, clsRes, currRes] = await Promise.all([
                        fetch(`./resources/${reg}/subjects.json`),
                        fetch(`./resources/${reg}/notes.json`),
                        fetch(`./resources/${reg}/classes.json`),
                        fetch(`./resources/${reg}/curriculum.json`) // Fetches from R22/curriculum.json
                    ]);

                    if (!subRes.ok || !noteRes.ok || !clsRes.ok) throw new Error("Resources not found");

                    this.data.subjects = await subRes.json();
                    this.data.notes = await noteRes.json();
                    const allClasses = await clsRes.json();

                    // Handle Curriculum safely (in case file is missing)
                    if (currRes.ok) {
                        this.data.curriculum = await currRes.json();
                    } else {
                        this.data.curriculum = [];
                        console.warn("Curriculum file not found for this regulation");
                    }

                    this.data.classes = allClasses.filter(c => c.batch === batch && c.dept === dept);

                    // Now that data is loaded, enable dropdown and populate
                    document.getElementById('yearSemSelect').disabled = false;
                    this.populateYearSemDropdown();

                    this.renderSubjects();
                    this.handleClassesLogic();

                    document.getElementById('welcomeState').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                    this.setStatus("Ready", "ready");

                } catch (e) {
                    console.error(e);
                    document.getElementById('subjectsContainer').innerHTML =
                        `<div class="p-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded">Error loading resources for ${reg}. Check file paths.</div>`;
                    this.setStatus("Error", "error");
                }
            },

            populateYearSemDropdown: function () {
                const sel = document.getElementById('yearSemSelect');
                const { batch, dept, yearSem } = this.state;

                sel.innerHTML = '<option value="">All Semesters</option>';

                // Filter curriculum for current batch/dept
                const validEntries = this.data.curriculum.filter(c => c.batch === batch && c.department === dept);

                // Sort (Year 1 Sem 1 -> Year 1 Sem 2 -> Year 2 Sem 1...)
                validEntries.sort((a, b) => (a.year - b.year) || (a.semester - b.semester));

                if (validEntries.length === 0) {
                    // If no entries found, disable select
                    const opt = document.createElement('option');
                    opt.textContent = "No Data";
                    sel.appendChild(opt);
                    sel.disabled = true;
                    return;
                }

                validEntries.forEach(entry => {
                    const opt = document.createElement('option');
                    opt.value = `${entry.year}-${entry.semester}`;
                    opt.textContent = `Year ${entry.year} - Sem ${entry.semester}`;
                    sel.appendChild(opt);
                });

                // Restore previous selection if it exists
                if (yearSem) {
                    sel.value = yearSem;
                }
            },

            handleClassesLogic: function () {
                const classSelect = document.getElementById('classSelect');
                const { classes } = this.data;

                if (classes.length === 0) {
                    classSelect.classList.add('hidden');
                    document.getElementById('projectsContainer').innerHTML = `<div class="p-6 text-center text-slate-500 italic">No classes found.</div>`;
                    return;
                }

                classSelect.innerHTML = '';
                classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.class_id;
                    opt.textContent = c.name || c.class_id;
                    classSelect.appendChild(opt);
                });

                this.state.currentClassId = classes[0].class_id;
                if (classes.length > 1) classSelect.classList.remove('hidden');
                else classSelect.classList.add('hidden');

                this.fetchProjects(this.state.currentClassId);
            },

            fetchProjects: async function (classId) {
                const { reg } = this.state;
                const container = document.getElementById('projectsContainer');
                container.innerHTML = `<div class="p-8 text-center text-slate-400 dark:text-slate-500 animate-pulse">Loading Projects...</div>`;

                try {
                    const res = await fetch(`./resources/${reg}/${classId}/projects.json`);
                    if (!res.ok) throw new Error("No projects");
                    const projects = await res.json();
                    this.renderProjects(projects);
                } catch (e) {
                    container.innerHTML = `<div class="p-8 text-center text-slate-400 dark:text-slate-500 italic">No projects uploaded.</div>`;
                }
            },

            renderSubjects: function () {
                const container = document.getElementById('subjectsContainer');
                const semesterText = document.getElementById('currentSemText');
                container.innerHTML = '';

                let validSubjectCodes = [];
                let curriculumEntries = [];

                // 1. First, find all curriculum entries for this Batch & Dept
                if (this.state.batch && this.state.dept) {
                    curriculumEntries = this.data.curriculum.filter(c =>
                        c.batch === this.state.batch &&
                        c.department === this.state.dept
                    );
                }

                // 2. If a specific Year/Sem is selected, filter further
                if (this.state.yearSem) {
                    const [y, s] = this.state.yearSem.split('-');
                    semesterText.textContent = `(Year ${y} - Sem ${s})`;

                    // Filter the entries to just this semester
                    curriculumEntries = curriculumEntries.filter(c => c.year == y && c.semester == s);
                } else {
                    semesterText.textContent = '(All Semesters)';
                }

                // 3. Collect all valid subject codes from the filtered curriculum entries
                curriculumEntries.forEach(entry => {
                    if (entry.subjects && Array.isArray(entry.subjects)) {
                        validSubjectCodes.push(...entry.subjects);
                    }
                });

                // 4. Filter the main subjects list against these codes
                // If curriculum is empty (e.g. data missing), we show nothing to prevent showing wrong subjects
                let visibleSubjects = [];
                if (validSubjectCodes.length > 0) {
                    visibleSubjects = this.data.subjects.filter(sub => validSubjectCodes.includes(sub.code));
                }

                // --- RENDER (No changes below this line) ---
                if (visibleSubjects.length === 0) {
                    container.innerHTML = `<div class="p-8 text-center text-slate-400 dark:text-slate-500 italic">No subjects found for this selection.</div>`;
                    return;
                }

                visibleSubjects.forEach((sub, index) => {
                    const subNotes = this.data.notes.filter(n => n.subject_code === sub.code);

                    let syllabusHtml = '';
                    if (sub.syllabus && sub.syllabus.units) {
                        syllabusHtml = sub.syllabus.units.map((unit, uIdx) => `
                            <details class="group mb-2 last:mb-0">
                                <summary class="flex cursor-pointer items-center justify-between rounded-lg bg-slate-50 dark:bg-slate-800 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors border border-transparent dark:border-slate-700">
                                    <span class="font-medium text-slate-700 dark:text-slate-300 text-sm">${unit.name}</span>
                                    <span class="text-slate-400 transition-transform group-open:rotate-180"><i class="ph ph-caret-down"></i></span>
                                </summary>
                                <div class="px-4 py-3 text-sm text-slate-600 dark:text-slate-400 bg-white dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 rounded-b-lg -mt-1">
                                    <ul class="list-disc pl-4 space-y-2">
                                        ${unit.topics.map(t => `
                                            <li><span class="font-semibold text-slate-800 dark:text-slate-200">${t.topic}</span>
                                            ${t.subTopics.length ? `<span class="text-slate-500 dark:text-slate-500 text-xs block mt-1">${t.subTopics.join(', ')}</span>` : ''}
                                            </li>`).join('')}
                                    </ul>
                                </div>
                            </details>`).join('');
                    }

                    let notesHtml = subNotes.length ? subNotes.map(note => `
                        <div class="flex flex-col sm:flex-row sm:items-start justify-between bg-indigo-50/50 dark:bg-slate-800/50 p-3 rounded-md border border-indigo-100 dark:border-slate-700 gap-3">
                            <div class="min-w-[150px]">
                                <div class="font-medium text-indigo-900 dark:text-indigo-300 text-sm flex items-center gap-2">
                                    <i class="ph ph-file-text"></i> ${note.resource_type}
                                </div>
                                <div class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">
                                    By <a href="${note.author_link}" target="_blank" class="hover:underline text-indigo-600 dark:text-indigo-400">${note.author_name}</a>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2 justify-start sm:justify-end">
                                ${note.links.map(l => `<a href="${l.link}" target="_blank" class="text-xs font-semibold bg-white dark:bg-slate-700 text-indigo-600 dark:text-indigo-300 px-3 py-1.5 border border-indigo-200 dark:border-slate-600 rounded hover:bg-indigo-600 dark:hover:bg-indigo-500 hover:text-white transition-colors whitespace-nowrap">${l.name}</a>`).join('')}
                            </div>
                        </div>`).join('') : `<div class="text-xs text-slate-400 italic pl-1">No notes available yet.</div>`;

                    const card = document.createElement('div');
                    card.className = "bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden fade-in transition-colors";
                    card.style.animationDelay = `${index * 50}ms`;
                    card.innerHTML = `
                        <div class="p-5 border-b border-slate-100 dark:border-slate-800 bg-gradient-to-r from-white to-slate-50 dark:from-slate-900 dark:to-slate-850">
                            <div class="flex justify-between items-start">
                                <div><h3 class="text-lg font-bold text-slate-800 dark:text-slate-100">${sub.name}</h3><span class="inline-block mt-1 text-xs font-mono font-semibold bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-2 py-0.5 rounded">${sub.code}</span></div>
                            </div>
                        </div>
                        <div class="p-5"><div class="mb-4"><h4 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2">Study Resources</h4><div class="space-y-2">${notesHtml}</div></div><div><h4 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2">Curriculum</h4>${syllabusHtml || '<div class="text-sm text-slate-400 italic">Syllabus data not available.</div>'}</div></div>`;
                    container.appendChild(card);
                });
            },
            renderProjects: function (projects) {
                const container = document.getElementById('projectsContainer');
                container.innerHTML = '';
                if (projects.length === 0) {
                    container.innerHTML = `<div class="p-8 text-center text-slate-400 italic">No projects found.</div>`;
                    return;
                }
                const grouped = projects.reduce((acc, p) => { (acc[p.type_category] = acc[p.type_category] || []).push(p); return acc; }, {});
                for (const [type, projs] of Object.entries(grouped)) {
                    const details = document.createElement('details');
                    details.className = "group border-b border-slate-100 dark:border-slate-800 last:border-0";
                    details.open = true;

                    let itemsHtml = projs.map(p => {
                        // Map all presentation links
                        const presentations = p.presentation_links.map((link, idx) => `
                            <a href="${link}" target="_blank" class="flex items-center gap-1 text-emerald-600 dark:text-emerald-400 hover:text-emerald-800 dark:hover:text-emerald-200 font-medium">
                                <i class="ph ph-presentation"></i> Presentation ${p.presentation_links.length > 1 ? idx + 1 : ''}
                            </a>
                        `).join('');

                        // Map all document links
                        const reports = p.documents.map((link, idx) => `
                            <a href="${link}" target="_blank" class="flex items-center gap-1 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 font-medium">
                                <i class="ph ph-file-pdf"></i> Report ${p.documents.length > 1 ? idx + 1 : ''}
                            </a>
                        `).join('');

                        return `
                        <div class="p-4 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-bold text-slate-700 dark:text-slate-200 text-sm">${p.team_no}: ${p.title}</span>
                            </div>
                            <div class="text-xs text-slate-500 dark:text-slate-400 mb-3">
                                ${p.members.map(m => `${m.name} <span class="opacity-70">(${m.roll})</span>`).join(', ')}
                            </div>
                            <div class="flex flex-wrap gap-x-4 gap-y-2 text-xs">
                                ${presentations}
                                ${reports}
                            </div>
                        </div>`;
                    }).join('');

                    details.innerHTML = `
                        <summary class="cursor-pointer bg-slate-50/80 dark:bg-slate-800/80 px-4 py-3 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide sticky top-0 backdrop-blur-sm flex justify-between items-center select-none">
                            ${type}
                            <i class="ph ph-caret-down text-slate-400 transition-transform group-open:rotate-180"></i>
                        </summary>
                        <div class="divide-y divide-slate-100 dark:divide-slate-800">${itemsHtml}</div>`;
                    container.appendChild(details);
                }
            },
            populateSelect: function (id, items) {
                const sel = document.getElementById(id);
                const placeholder = sel.firstElementChild;
                sel.innerHTML = '';
                sel.appendChild(placeholder);
                items.forEach(item => { const opt = document.createElement('option'); opt.value = item; opt.textContent = item; sel.appendChild(opt); });
            },

            setStatus: function (msg, type) {
                const wrapper = document.getElementById('statusIndicator');
                const dot = document.getElementById('statusDot');
                const pulse = document.getElementById('statusDotPulse');
                const text = document.getElementById('statusText');
                text.innerText = msg;
                const themes = {
                    ready: { wrapper: "bg-emerald-50 border-emerald-100 text-emerald-700 dark:bg-emerald-500/10 dark:border-emerald-500/20 dark:text-emerald-400", dot: "bg-emerald-500", pulse: "bg-emerald-400" },
                    loading: { wrapper: "bg-amber-50 border-amber-100 text-amber-700 dark:bg-amber-500/10 dark:border-amber-500/20 dark:text-amber-400", dot: "bg-amber-500", pulse: "bg-amber-400" },
                    error: { wrapper: "bg-rose-50 border-rose-100 text-rose-700 dark:bg-rose-500/10 dark:border-rose-500/20 dark:text-rose-400", dot: "bg-rose-500", pulse: "bg-rose-400" }
                };
                const theme = themes[type] || themes.ready;
                wrapper.className = `hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full border text-xs font-semibold transition-all duration-300 ${theme.wrapper}`;
                dot.className = `relative inline-flex rounded-full h-2 w-2 ${theme.dot}`;
                pulse.className = `animate-ping absolute inline-flex h-full w-full rounded-full opacity-75 ${theme.pulse}`;
                if (type === 'error') pulse.classList.add('hidden'); else pulse.classList.remove('hidden');
            },

            updateUIValues: function () {
                if (this.state.reg) document.getElementById('regSelect').value = this.state.reg;
                if (this.state.batch) document.getElementById('batchSelect').value = this.state.batch;
                if (this.state.dept) document.getElementById('deptSelect').value = this.state.dept;
                if (this.state.yearSem) document.getElementById('yearSemSelect').value = this.state.yearSem;
                if (this.state.reg) {
                    document.getElementById('batchSelect').disabled = false;
                    document.getElementById('deptSelect').disabled = false;
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>

</html>